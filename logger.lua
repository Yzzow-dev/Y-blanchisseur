Logger = {}

-- Cache des logs pour √©viter le spam
local logCache = {}
local logQueue = {}
local isProcessingQueue = false

-- Fonction principale pour envoyer un log
function Logger.Send(logType, title, description, fields, color)
    if not Config.Discord.Enable then
        return
    end
    
    -- D√©terminer le webhook √† utiliser
    local webhook = Config.Discord.AdminWebhook
    if logType == 'security' or logType == 'cheat' then
        webhook = Config.Discord.SecurityWebhook
    end
    
    -- Cr√©er l'embed
    local embed = {
        title = title,
        description = description,
        color = color or Config.Discord.Colors.Admin,
        fields = fields or {},
        timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ"),
        footer = {
            text = Config.Discord.ServerName .. " | Admin System v" .. Config.Version,
            icon_url = Config.Discord.ServerIcon
        }
    }
    
    -- Ajouter √† la queue
    table.insert(logQueue, {
        webhook = webhook,
        embed = embed
    })
    
    -- Traiter la queue si elle n'est pas d√©j√† en cours
    if not isProcessingQueue then
        ProcessLogQueue()
    end
end

-- Fonction pour traiter la queue des logs
function ProcessLogQueue()
    if #logQueue == 0 then
        isProcessingQueue = false
        return
    end
    
    isProcessingQueue = true
    
    Citizen.CreateThread(function()
        while #logQueue > 0 do
            local logData = table.remove(logQueue, 1)
            
            -- Envoyer le log
            PerformHttpRequest(logData.webhook, function(err, text, headers)
                if Config.Debug then
                    if err == 200 then
                        print("^2[Admin System] Log Discord envoy√© avec succ√®s^0")
                    else
                        print("^1[Admin System] Erreur lors de l'envoi du log Discord: " .. err .. "^0")
                    end
                end
            end, 'POST', json.encode({
                username = "Admin System",
                avatar_url = Config.Discord.ServerIcon,
                embeds = {logData.embed}
            }), {
                ['Content-Type'] = 'application/json'
            })
            
            -- Attendre un peu pour √©viter les limites de taux
            Citizen.Wait(1000)
        end
        
        isProcessingQueue = false
    end)
end

-- Fonction pour logger une action staff
function Logger.LogStaffAction(source, action, target, details)
    local staffInfo = GetPlayerInfo(source)
    local targetInfo = target and GetPlayerInfo(target) or nil
    
    if not staffInfo then
        return
    end
    
    local fields = {
        {
            name = "üë§ Staff",
            value = string.format("**%s** (%s)\nGroupe: %s\nID: %d", 
                staffInfo.name, staffInfo.identifier, staffInfo.group, staffInfo.id),
            inline = true
        },
        {
            name = "üéØ Action",
            value = action,
            inline = true
        }
    }
    
    if targetInfo then
        table.insert(fields, {
            name = "üéÆ Cible",
            value = string.format("**%s** (%s)\nGroupe: %s\nID: %d", 
                targetInfo.name, targetInfo.identifier, targetInfo.group, targetInfo.id),
            inline = true
        })
    end
    
    if details then
        table.insert(fields, {
            name = "üìÑ D√©tails",
            value = details,
            inline = false
        })
    end
    
    Logger.Send('admin', 'üõ†Ô∏è Action Staff - Admin Panel', 
        string.format("Action **%s** effectu√©e par %s", action, staffInfo.name), 
        fields, Config.Discord.Colors.Admin)
end

-- Fonction pour logger une action joueur
function Logger.LogPlayerAction(source, action, details)
    local playerInfo = GetPlayerInfo(source)
    
    if not playerInfo then
        return
    end
    
    local fields = {
        {
            name = "üë§ Joueur",
            value = string.format("**%s** (%s)\nGroupe: %s\nID: %d", 
                playerInfo.name, playerInfo.identifier, playerInfo.group, playerInfo.id),
            inline = true
        },
        {
            name = "üéØ Action",
            value = action,
            inline = true
        }
    }
    
    if details then
        table.insert(fields, {
            name = "üìÑ D√©tails",
            value = details,
            inline = false
        })
    end
    
    Logger.Send('player', 'üéÆ Action Joueur - Admin Panel', 
        string.format("Action **%s** par %s", action, playerInfo.name), 
        fields, Config.Discord.Colors.Player)
end

-- Fonction pour logger un probl√®me de s√©curit√©
function Logger.LogSecurity(source, violation, details)
    local playerInfo = GetPlayerInfo(source)
    
    if not playerInfo then
        return
    end
    
    local fields = {
        {
            name = "‚ö†Ô∏è Joueur Suspect",
            value = string.format("**%s** (%s)\nGroupe: %s\nID: %d", 
                playerInfo.name, playerInfo.identifier, playerInfo.group, playerInfo.id),
            inline = true
        },
        {
            name = "üîç Type de Violation",
            value = violation,
            inline = true
        },
        {
            name = "üìç Position",
            value = string.format("X: %.2f, Y: %.2f, Z: %.2f", 
                playerInfo.coords.x, playerInfo.coords.y, playerInfo.coords.z),
            inline = true
        }
    }
    
    if details then
        table.insert(fields, {
            name = "üìÑ D√©tails",
            value = details,
            inline = false
        })
    end
    
    Logger.Send('security', 'üîê Probl√®me de S√©curit√©', 
        string.format("Violation **%s** d√©tect√©e", violation), 
        fields, Config.Discord.Colors.Security)
end

-- Fonction pour logger une d√©tection de triche
function Logger.LogCheat(source, cheatType, details)
    local playerInfo = GetPlayerInfo(source)
    
    if not playerInfo then
        return
    end
    
    local fields = {
        {
            name = "üö® Tricheur D√©tect√©",
            value = string.format("**%s** (%s)\nGroupe: %s\nID: %d", 
                playerInfo.name, playerInfo.identifier, playerInfo.group, playerInfo.id),
            inline = true
        },
        {
            name = "üîç Type de Triche",
            value = cheatType,
            inline = true
        },
        {
            name = "üìç Position",
            value = string.format("X: %.2f, Y: %.2f, Z: %.2f", 
                playerInfo.coords.x, playerInfo.coords.y, playerInfo.coords.z),
            inline = true
        },
        {
            name = "üïí Ping",
            value = playerInfo.ping .. " ms",
            inline = true
        }
    }
    
    if details then
        table.insert(fields, {
            name = "üìÑ D√©tails",
            value = details,
            inline = false
        })
    end
    
    Logger.Send('cheat', 'üö® Cheat Detected', 
        string.format("Triche **%s** d√©tect√©e", cheatType), 
        fields, Config.Discord.Colors.Cheat)
end

-- Fonction pour logger les connexions/d√©connexions
function Logger.LogConnection(source, action, reason)
    local playerInfo = GetPlayerInfo(source)
    
    if not playerInfo then
        return
    end
    
    local fields = {
        {
            name = "üë§ Joueur",
            value = string.format("**%s** (%s)\nGroupe: %s\nID: %d", 
                playerInfo.name, playerInfo.identifier, playerInfo.group, playerInfo.id),
            inline = true
        },
        {
            name = "üéØ Action",
            value = action,
            inline = true
        }
    }
    
    if reason then
        table.insert(fields, {
            name = "üìÑ Raison",
            value = reason,
            inline = false
        })
    end
    
    local color = action == "Connexion" and Config.Discord.Colors.Player or Config.Discord.Colors.Admin
    
    Logger.Send('player', 'üîó Connexion Joueur', 
        string.format("**%s** - %s", action, playerInfo.name), 
        fields, color)
end

-- Fonction pour logger les commandes
function Logger.LogCommand(source, command, args)
    local playerInfo = GetPlayerInfo(source)
    
    if not playerInfo then
        return
    end
    
    local fields = {
        {
            name = "üë§ Joueur",
            value = string.format("**%s** (%s)\nGroupe: %s\nID: %d", 
                playerInfo.name, playerInfo.identifier, playerInfo.group, playerInfo.id),
            inline = true
        },
        {
            name = "üíª Commande",
            value = "/" .. command,
            inline = true
        }
    }
    
    if args and #args > 0 then
        table.insert(fields, {
            name = "üìÑ Arguments",
            value = table.concat(args, " "),
            inline = false
        })
    end
    
    Logger.Send('admin', 'üíª Commande Ex√©cut√©e', 
        string.format("Commande **/%s** par %s", command, playerInfo.name), 
        fields, Config.Discord.Colors.Admin)
end

-- Fonction pour logger les sanctions
function Logger.LogSanction(source, target, sanctionType, reason, duration)
    local staffInfo = GetPlayerInfo(source)
    local targetInfo = GetPlayerInfo(target)
    
    if not staffInfo or not targetInfo then
        return
    end
    
    local fields = {
        {
            name = "üë§ Staff",
            value = string.format("**%s** (%s)\nGroupe: %s\nID: %d", 
                staffInfo.name, staffInfo.identifier, staffInfo.group, staffInfo.id),
            inline = true
        },
        {
            name = "üéØ Sanctionn√©",
            value = string.format("**%s** (%s)\nGroupe: %s\nID: %d", 
                targetInfo.name, targetInfo.identifier, targetInfo.group, targetInfo.id),
            inline = true
        },
        {
            name = "‚öñÔ∏è Type",
            value = sanctionType,
            inline = true
        }
    }
    
    if reason then
        table.insert(fields, {
            name = "üìÑ Raison",
            value = reason,
            inline = false
        })
    end
    
    if duration then
        table.insert(fields, {
            name = "‚è±Ô∏è Dur√©e",
            value = duration,
            inline = true
        })
    end
    
    Logger.Send('admin', '‚öñÔ∏è Sanction Appliqu√©e', 
        string.format("**%s** sanctionn√© par %s", targetInfo.name, staffInfo.name), 
        fields, Config.Discord.Colors.Admin)
end

-- Fonction pour logger les erreurs syst√®me
function Logger.LogError(error, details)
    local fields = {
        {
            name = "‚ùå Erreur",
            value = error,
            inline = false
        }
    }
    
    if details then
        table.insert(fields, {
            name = "üìÑ D√©tails",
            value = details,
            inline = false
        })
    end
    
    Logger.Send('security', '‚ùå Erreur Syst√®me', 
        "Une erreur syst√®me s'est produite", 
        fields, Config.Discord.Colors.Cheat)
end

-- Fonction pour logger les red√©marrages serveur
function Logger.LogRestart(source, type, reason)
    local staffInfo = source and GetPlayerInfo(source) or nil
    
    local fields = {}
    
    if staffInfo then
        table.insert(fields, {
            name = "üë§ Staff",
            value = string.format("**%s** (%s)\nGroupe: %s\nID: %d", 
                staffInfo.name, staffInfo.identifier, staffInfo.group, staffInfo.id),
            inline = true
        })
    end
    
    table.insert(fields, {
        name = "üîÑ Type",
        value = type,
        inline = true
    })
    
    if reason then
        table.insert(fields, {
            name = "üìÑ Raison",
            value = reason,
            inline = false
        })
    end
    
    Logger.Send('admin', 'üîÑ Red√©marrage Serveur', 
        string.format("Red√©marrage **%s** du serveur", type), 
        fields, Config.Discord.Colors.Admin)
end

-- Fonction utilitaire pour v√©rifier si un log est en cache (anti-spam)
function IsLogCached(logKey, duration)
    duration = duration or 5000 -- 5 secondes par d√©faut
    
    if logCache[logKey] then
        if GetGameTimer() - logCache[logKey] < duration then
            return true
        end
    end
    
    logCache[logKey] = GetGameTimer()
    return false
end

-- Nettoyer le cache des logs p√©riodiquement
Citizen.CreateThread(function()
    while true do
        Citizen.Wait(300000) -- 5 minutes
        
        local currentTime = GetGameTimer()
        for key, time in pairs(logCache) do
            if currentTime - time > 300000 then -- 5 minutes
                logCache[key] = nil
            end
        end
    end
end)